<div style="page-break-before:always;">
</div>

# <a name="snatch"></a>6. Анализ поверхности атаки с помощью SNatch

*SNatch* – это инструмент с графическим интерфейсом, предназначенный для постобработки и отображения данных, полученных от инструмента *Natch*. Работать с этим интерфейсом можно через браузер.

## 6.1. Системные требования

Тестирование инструмента проводилось на ОС Ubuntu 20.04 и Ubuntu 22.04. В качестве браузеров использовались Google Chrome версии 105.0.5148.2 и выше и Mozilla Firefox версии 101.0 и выше.

Необходимые для функционирования *SNatch* пакеты будут автоматически установлены в ходе первоначальной настройки.

## 6.2. Настройка и запуск

Для работы графического интерфейса *SNatch* необходимо подготовить окружение, а именно установить ряд пакетов для Ubuntu и Python, а также создать базу данных. Все это делается автоматически с помощью скрипта *snatch_setup.sh*. Для установки потребуется пароль для sudo. **Важно! Запускать скрипт под sudo не нужно, дождитесь запроса пароля.** Пакеты для Python устанавливаются в виртуальную среду, таким образом пакеты на вашей машине не будут переустанавливаться и конфликтовать. Запускать скрипт нужно только при первом использовании, его повторный запуск приведет к удалению базы данных.

Помимо скрипта для настройки окружения в пакет поставки входят скрипты *snatch_start.sh* и *snatch_stop.sh* для запуска и остановки *SNatch* соответственно. Скрипт *snatch_start.sh* запускает необходимые для работы службы, а также открывает браузер с интерфейсом. В терминал, из которого был запущен скрипт, будут приходить сообщения от сервера, однако, он свободен для использования, поэтому по окончании работы из него же можно запустить скрипт *snatch_stop.sh* для остановки служб. Запускать *snatch_stop.sh* следует всегда, в противном случае процессы останутся висеть в памяти вашего компьютера до перезагрузки.

Все скрипты для *SNatch* можно запускать из любого расположения. Если по какой-то причине при запуске
*snatch_start.sh* страница в браузере не загрузилась, но при этом службы запустились, следует обновить страницу.

После выполнения скрипта *snatch_start.sh* в этом же терминале начнут выводится информационные сообщения о работе *SNatch* и сообщения о возникающих ошибках. Полученные сообщения можно использовать для отслеживания внутреннего процесса работы *SNatch* и в качестве данных при формировании обращений об обнаруженных багах. Помимо этого ведется логирование работы в файл *snatch.log*, который расположен в папке *Snatch*.

## 6.3. Работа со *SNatch*

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_main_ui.png><figcaption>_Окно SNatch_</figcaption>

На данном рисунке показано окно *SNatch*, где цифрами обозначены основные элементы интерфейса:

1. Кнопка для повторной загрузки архива полученного от *Natch*. При нажатии на эту кнопку информация о текущем проекте будет стерта, вкладки закрыты, и будет запущена обработка выбранного архива.
2. Кнопки генерации дополнительных графов. Граф вызовов и флейм граф не строятся автоматически при создании проекта. Для их генерации необходимо нажать на соответствующие кнопки. После нажатия на кнопке появится индикатор прогресса. При повторном нажатии на кнопку процесс генерации будет отменен. По завершении процесса кнопка исчезнет, а соответствующий пункт в меню станет активным.
3. Меню проекта. Содержит список доступных данных для проекта (таких как: граф процессов, граф модулей, дерево процессов, граф вызовов и т.д.)
4. Всплывающее меню для взаимодействия с проектами (создание нового, открытие и удаление существующего).
5. Кнопка открытия меню взаимодействия с проектами.
6. Название открытого проекта. По нажатию на название имя проекта можно изменять.
7. Панель открытых вкладок с содержимым. Каждая вкладка содержит имя и кнопку закрытия. Также на панели представлена кнопка для быстрого закрытия всех вкладок.
8. Окно отображения содержимого.

### 6.3.1. Создание проекта

Для создания нового проекта необходимо нажатием на (6) открыть меню проектов и выбрать *New project...*. Для переключения между существующим проектами необходимо из меню проектов в списке *Existing projects:* выбрать название интересующего проекта. Для удаления проекта достаточно в списке проектов нажать на кнопку *del* рядом с именем удаляемого проекта.

При нажатии на (1) в уже открытом проекте пользователю будет предложено выбрать новый архив (данный архив получается в результате работы *Natch*), после чего текущие данные в проекте будут стёрты и заменены полученными в результате обработки предоставленного файла.

При создании нового проекта открывается модальное окно:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_new_proj_modal.png><figcaption>_Создание проекта_</figcaption>

В данном окне пользователь должен ввести имя нового проекта в соответствующее поле *Project name*,
а также выбрать архив от *Natch* в поле *Choose surface file*. Эти поля являются обязательными при создании проекта, поэтому только при их заполнении становится активна кнопка *Create*. По нажатию на *Create* создаётся проект, запускается обработка архива, и окно закрывается. При нажатии на кнопку *Close* окно закрывается без создания проекта.

Помимо обязательных полей в данном окне присутствует опциональное поле *Description* в котором можно оставить пометки о загружаемом архиве. При работе с проектом эту информацию можно будет увидеть в разделе *About project*.

Название проекта не может содержать ряд специальных символов, и *Snatch* не даст их использовать как при первичном создании проекта, так и при переименовании.

При обработке архива можно параллельно запускать создание новых проектов, однако это может привести к общему замедлению работы.

Во время обработки архива поверхности атаки в верхней части экрана появляется шкала прогресса следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_progressbar.png><figcaption>_Шкала прогресса_</figcaption>

В процессе обработки текст, сопровождающий шкалу прогресса, будет изменяться таким образом, чтобы оповещать об актуальном статусе выполняемой задачи. Нажатие на кнопку *Abort* прерывает процесс обработки. Проект при этом следует удалить самостоятельно.

При создании проекта (и открытии проекта без сохраненных вкладок) в нём по умолчанию открывается окно графа процессов.

### 6.3.2. Граф процессов

Граф процессов открывается автоматически после создания проекта. Позже его можно снова открыть через меню.
В меню графа процессов есть два пункта: *Process-graph* и *Process-graph content* (json представление графа). После выбора одного из этих пунктов открывается новая вкладка с соответствующим названием. Для *Process-graph content* содержимое вкладки будет представлено текстом, а для *Process-graph* откроется вкладка следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_process_graph.png><figcaption>_Граф процессов_</figcaption>

В окне графа процессов представлены следующие элементы:

1. Шкала выбора активного шага выполнения. Перемещение по данной шкале соответствующим образом изменяет отображаемый граф.
2. Выбор режима отображения графа. Граф процессов поддерживает 4 режима отображения:
  * *Active* – отображаются элементы (узлы и стрелки), которые задействованы на текущем шаге;
  * *Past* – отображаются элементы, которые задействованы на текущем шаге, а также те, которые произошли в прошлом (узлы и стрелки серого цвета);
  * *Significant* – отображаются элементы, которые задействованы на текущем шаге, а также те узлы, которые были задействованы в прошлом и при этом еще будут задействованы в будущем, и прошедшие стрелки между ними (узлы и стрелки бледных цветов);
  * *All* – отображаются элементы, которые задействованы на текущем шаге, а также те узлы (но не стрелки), которые вообще существуют на схеме (узлы бледных цветов).
3. Легенда графа. Описывает набор отображаемых на графе узлов и их внешний вид.
4. Граф процессов. Интерактивный граф, отображающий взаимодействие процессов, работавших с помеченными данными. Расположение узлов на графе можно изменять удобным для пользователя образом. При двойном нажатии на узел в данном графе произойдет открытие новой вкладки с отображением графа модулей для выбранного процесса. При наличии информации о контейнерах, таковые будут отображены на графе в виде зеленых блоков, содержащих соответствующие им процессы.

При нажатии правой кнопкой мыши на узел в графе процессов появляется контекстное меню, из которого можно осуществить взаимодействие со *Svacer*. При первой попытке взаимодействия пользователю будет предложено установить адрес сервера, имя и пароль пользователя (если ранее это не было установлено через раздел *Settings*). Затем пользователь увидит окно следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_svacer.png><figcaption>_Параметры открытия Svacer_</figcaption>

В данном окне можно выбрать проект *Svace*, ветку и снэпшот. После нажатия на кнопку *Open* будет открыто новое окно браузера со Svacer сконфигурированным в соответствии с установленными параметрами.

### 6.3.3. Граф модулей

В меню графа процессов есть два пункта: *Module-graph* и *Module-graph content* (json представление графа). После выбора одного из этих пунктов открывается новая вкладка с соответствующим названием. Для *Module-graph content* содержимое вкладки будет представлено текстом, а для *Module-graph* откроется вкладка следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_module_graph.png><figcaption>_Граф модулей_</figcaption>

В данном окне представлены следующие элементы:

1. Шкала выбора активного шага выполнения. Перемещение по данной шкале соответствующим образом изменяет отображаемый граф.
2. Легенда графа. Описывает набор отображаемых на графе узлов и их внешний вид.
3. Граф модулей. Интерактивный граф, отображающий взаимодействие модулей, работавших с помеченными данными. Расположение узлов на графе можно изменять удобным для пользователя образом. Стрелки, описывающие взаимодействие, сопровождаются номером, соответствующим очередности взаимодействия. Номер с символом *(звездочкой) означает, что на данном шаге между модулями было более одного взаимодействия.

### 6.3.4. Граф вызовов

В процессе первоначальной обработки архива поверхности атаки граф вызовов не создаётся. Чтобы граф вызовов появился в проекте, необходимо нажать на кнопку *Generate* рядом с соответствующим пунктом в меню проекта. Повторное нажатие кнопки до завершения генерации приведет к отмене процесса. По завершении генерации в боковом меню проекта под пунктом *Additional graphs* станет активным пункт *call-graph*. Для открытия графа вызовов достаточно нажать на данный пункт в меню. После открытия появится новая вкладка с соответствующим названием, а в окне отображения содержимого откроется граф, представленный в виде древовидной структуры:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_call_graph.png><figcaption>_Граф вызовов_</figcaption>

В данном окне представлены следующие элементы:

1. Чекбоксы опций. *Hide symbolless graphs* прячет из отображаемого графа деревья, не содержащие распознанных символов (если данная опция неактивна, то в текущем проекте все деревья содержат символьную информацию); *Full modules path* задаёт формат отображения имен модулей на графе: сокращенный или полный путь.
2. Элементы управления графом. Первая кнопка (три горизонтальные черты) раскрывает все ветви графа, содержащие символы; повторное нажатие этой кнопки сворачивает весь граф. Нажатие на кнопки +/- рядом с веткой раскрывает/сворачивает данную ветку в дереве.
3. Содержимое графа. В корне дерева отображается имя процесса, к которому относится данный граф вызовов. Каждый узел дерева содержит имя вызванной функции (адрес смещения в модуле, при отсутствии символьной информации), путь к файлу исходного кода и строка в файле, относящаяся к началу функции, имя модуля. Синим цветом выделяются функции непосредственно взаимодействовавшие с помеченными данными. При наведении курсора на "синие" функции возникает всплывающая подсказка, содержащая номера строк в исходниках, где происходило взаимодействие с помеченными данным. При нажатии на функцию правой кнопкой мыши появляется контекстное меню, из которого можно запустить генерацию вспомогательных данных для Futag. Сгенерированные данные будут помещены в файл в папке *snatch_directory/fuzzing_targets*.

### 6.3.5. Флейм граф

В процессе первоначальной обработки архива от *Natch* флейм граф не создаётся. По аналогии с графом вызовов необходимо нажать на кнопку *Generate* и по завершении вызвать флейм граф нажатием на пункт в меню проекта. В открывшейся вкладке будет показан флейм граф следующего вида:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_flame_graph.png><figcaption>_Флейм граф_</figcaption>

В данном окне представлены следующие элементы:

1. Выпадающий список построенных флейм графов, сгруппированный по процессам. Графы, относящиеся к пользовательским потокам, помечены словом *user*, выполнявшиеся ядром – *kernel*. При нажатии на пункт списка произойдет открытие соответствующего флейм графа.
2. Кнопки навигации по флейм графу. Используются для перемещения между функциями, работавшими с помеченными данными. Нажатие на кнопку *вперед* делает активным следующую такую функцию, *назад* – предыдущую, а *Reset zoom* сбрасывает граф к исходному состоянию (активным становится корневой блок)
3. Список функций, работавших с помеченными данными. В данном списке показано имя функции (либо смещение относительно модуля, в отсутствии символьной информации) и продолжительность работы функции (синим цветом) в выполненных процессорных инструкциях. При нажатии на пункт в этом списке, соответствующая функция на флейм графе становится активной.
4. Флейм граф. В верхней части показано имя открытого флейм графа. При нажатии на любой блок флейм графа он становится активным, т.е. занимает 100% ширины графа, с соответствующим расширением дочерних блоков. Синим цветом на флейм графе отображаются функции, взаимодействовавшие с помеченными данными. При наведении курсора на "синие" функции возникает всплывающая подсказка, содержащая адреса в исходниках, где происходило взаимодействие с помеченными данными.

### 6.3.6. Временной граф процессов

Для открытия временного графа процессов необходимо вызвать из меню проекта пункт *Process-timeline*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_process_timeline.png><figcaption>_Временной граф процессов_</figcaption>

В данном окне представлены следующие элементы:

1. Набор фильтров отображаемой информации. При установленной галочке *Kernel* на графе будут отображаться процессы уровня ядра; при галочке *Container* будут отображаться служебные процессы функционирования контейнеров (на данный момент docker).
2. Временной граф процессов. Представляет собой граф, где горизонтальная ось отображает время выполнения процесса, от его начала и до завершения. Граф поддерживает изменение масштабов по временной оси с помощью колесика мыши. Синим цветом на графе показаны процессы, в которых происходило взаимодействие с помеченными данными. При наведении на процесс появляется всплывающая подсказка со следующей информацией о процессе (не для всех процессов доступен полный набор информации): имя процесса, pid, путь к исполняемому файлу, исполняемая команда, родительские процессы, список процессов-потомков. При двойном нажатии на процесс происходит открытие новой вкладки с графом процессов на шаге, соответствующем началу работы данного процесса.

По умолчанию граф полностью вмещается по ширине в отображаемое окно, однако можно увеличить масштаб графа с помощью комбинации *Ctrl+Scroll*. В таком случае движение по горизонтальной оси для просмотра графа осуществляется с помощью перетаскивания графа с зажатой левой кнопкой мыши. Движение по вертикальной оси при этом осуществляется с помощью *Scroll* мышью.

### 6.3.7. Дерево процессов

Для открытия дерева процессов необходимо вызвать из меню проекта пункт *Process-tree*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_process_tree.png><figcaption>_Дерево процессов_</figcaption>

На дереве процессов показано отношение между процессами в формате "родитель-потомок", при этом процессы непосредственно взаимодействовавшие с помеченными данными, выделены синим цветом. Ярко-розовым цветом выделены процессы, запущенные с правами root и работавшие с помеченными данными, а бледно-розовым - просто запущенные от root. Помимо имени процесса на графе также отображаются его идентификаторы pid и uid, и команда, которой он был запущен (если удалось её определить).

Для дерева доступен фильтр *Tainted only*, который оставляет в дереве только те процессы, которые работали с помеченными данными, или являлись родителями процессов, работавших с помеченными данными.

### 6.3.8. Список ресурсов

Для открытия списка ресурсов проекта необходимо вызвать из меню проекта пункт *Resources*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_resources.png><figcaption>_Список ресурсов_</figcaption>

Ресурсы описываются древовидной структурой, где в корне располагается название процесса. Цветовая индикация процессов означают следующее: бледно-розовые - процессы с root-привилегиями; ярко-розовые - процессы с root-привилегиями, взаимодействовавшие с помеченными данными; синие - пользовательские процессы, взаимодействовавшие с помеченными данными. Для каждого процесса при наличии будут отображены: используемые им модули (синим обозначены работавшие с помеченными данными) с полным именем и базовым адресом загрузки; использованные сокеты; использованные файлы; использованные скрипты.

Для списка ресурсов доступен фильтр *Tainted only*, который оставляет в списке только те процессы, которые работали с помеченными данными.

### 6.3.9. Список файлов

Для открытия списка файлов проекта необходимо вызвать из меню проекта пункт *Files*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_files.png><figcaption>_Список файлов_</figcaption>

В списке представлены файлы, с которыми была работа в сценарии. Голубым цветом отмечены файлы, в которые попали помеченные данные. Для каждого файла можно развернуть список процессов, которые взаимодейстовали с файлом (открывали/читали/писали/запускали его). Если файл открывал процесс ядра, то в список этот файл не попадет. В список процессов процессы ядра также не попадают. Цветовая индикация процессов аналогична используемой в списке ресурсов. В боковом меню отображается информация о выбранном процессе.

Для списка доступны фильтры по имени директории, в которой расположен файл. Если фильтр недоступен, значит нет ни одного файла, подпадающего под него.

### 6.3.10. Сетевой трафик

Доступ к информации о сетевом трафике будет предоставлен только при сборе соответствующих данных во время работы *Natch* (это делается по умолчанию, а в архив помещается \*.pcap файл). Для интерактивной работы с предоставленными данными необходимо иметь установленный в системе *wireshark*.
Для открытия данных о сетевом трафике проекта необходимо вызвать из меню проекта пункт *Traffic*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_traffic.png><figcaption>_Сетевой трафик_</figcaption>

Окно содержит следующие элементы:

1. Кнопка открытия в *wireshark* pcap файла с сетевыми пакетами (только входящими), которые были помечены в анализируемом сценарии. Открытие *wireshark* с нужным файлом произойдет автоматически.
2. Кнопка открытия в *wireshark* pcap файла с сетевыми пакетами (входящими и исходящими), которые появлялись в анализируемом сценарии. 
3. Кнопка открытия в *wireshark* pcap файла с сетевыми пакетами (входящими и исходящими), которые появлялись в системе, начиная со старта.
4. Список MAC-адресов, участвоваших в работе анализируемого сценария. По нажатию на элемент списка произойдет открытие *wireshark* с примененным фильтром для выбранного устройства.
5. Список сетевых сессий (взаимодействий между двумя сетевыми адресами), участвоваших в работе анализируемого сценария. Нажатие на элемент списка запустит *wireshark* с фильтром на взаимодействие между указанными адресами. Зеленый блок в заголовке описывает количество элементов в списке.

### 6.3.11. Окно настроек

Для открытия окна настроек необходимо вызвать из меню проекта пункт *Settings*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_settings.png><figcaption>_Настройки_</figcaption>

В настоящий момент в настройках представлены только поля для конфигурации соединения со *Svacer*, а именно: сетевой адрес, логин и пароль. Это же окно будет открыто при первой попытке взаимодействия со *Svacer* из графа процессов, если параметры соединения не были ранее заданы.

### 6.3.12. Информация о проекте

Для открытия информации о проекте необходимо вызвать из меню проекта пункт *About project*. Содержимое открытой вкладки будет иметь следующий вид:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_about.png><figcaption>_Данные о проекте_</figcaption>

Окно содержит следующие элементы:

1. Заметки для проекта. По умолчанию здесь размещается содержимое поля *Description*, если оно было использовано при создании проекта. Заметки можно редактировать, сохранение происходит автоматически.
2. Данные о загруженном архиве: дата создания, рабочая директория, диапазон шагов (процессорных инструкций) сценария, допуск пометок, данные о рассматриваемых источниках пометок.
3. Версия *Natch*, на которой происходила запись архива.

## 6.4. Список горячих клавиш

### 6.4.1. Общие комбинации

- *Ctrl+Alt+N* – вызывает модальное окно создания нового проекта
- *Ctrl+Alt+G* – запускает одновременную генерацию флейм графа и графа вызовов
- *Ctrl+Alt+C* – открывает граф вызовов (при наличии)
- *Ctrl+Alt+F* – открывает флейм граф (при наличии)
- *Ctrl+Alt+P* – открывает граф процессов
- *Ctrl+Alt+M* – открывает граф модулей
- *Ctrl+Alt+L* – открывает временной граф процессов
- *Ctrl+Alt+R* – открывает дерево процессов
- *Ctrl+Alt+E* – открывает список ресурсов
- *Ctrl+Alt+I* – открывает сетевой трафик
- *Ctrl+X* – закрывает текущую вкладку в окне *SNatch*. Также вкладку можно закрыть по нажатию колесиком мыши.
- *Ctrl+Shift+X* – закрывает все открытые вкладки в окне *SNatch*
- *Shift+Tab* – выбирает следующую открытую вкладку в окне *SNatch*

### 6.4.2. Управление интерактивными элементами вкладок

Флейм граф:

- *→* – переход к следующей помеченной функции
- *←* – переход к предыдущей помеченной функции
- *Ctrl+↓* – сброс состояния flame графа

Граф процессов:

- *→* – переход к следующему шагу
- *←* – переход к предыдущему шагу
- *Ctrl+→* – переход к последнему шагу
- *Ctrl+←* – переход к первому шагу
- *Ctrl+↓* – выбор предыдущего режима отображения
- *Ctrl+↑* – выбор следующего режима отображения

Граф модулей:

- *→* – переход к следующему шагу
- *←* – переход к предыдущему шагу
- *Ctrl+→* – переход к последнему шагу
- *Ctrl+←* – переход к первому шагу

## 6.5. Отладочная информация

При возникновении ошибок следует обратиться к отладочной информации и передать её разработчикам с описанием сценария возникновения ошибки. Отладочная информация выводится в файл *snatch.log* в корне *Snatch*.
