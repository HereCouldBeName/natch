<div style="page-break-before:always;">
</div>

# 4. Запуск Natch

В комплект поставки инструмента *Natch* входят документация и исполняемые файлы. Исполняемые файлы разделены на две категории - собственно исполняемые файлы *Natch* и комплект необходимых для работы разделяемых библиотек. При запуске на машине без установленных библиотек может потребоваться явно указать путь к библиотекам, используя механизм `LD_PRELOAD`, а именно определить переменную *LD_LIBRARY_PATH*, указав ей путь к распакованному архиву с библиотеками следующим образом:   
```bash
LD_LIBRARY_PATH=/path_to_libs ./natch_run.py path_to_image
```

## <a name="natch_run_label"></a>4.2. Использование скрипта для генерации командных строк запуска

В поставку инструмента входит скрипт *natch_run.py*, который нужен для генерации командных строк для запуска *Natch*, а так же для первоначальной настройки инструмента.

Перед работой нужно установить зависимости из списка *requirements.txt* с помощью команды:
```bash
pip3 install -r requirements.txt
```
Зависимости, описанные в файле *requirements.txt* общие для всех python-скриптов инструмента и достаточно уставить их один раз.

В процессе выполнения скрипта пользователь должен уточнять параметры запуска инструмента. На выходе сформируются три скрипта: *run_record.sh* и *run_replay.sh* для запуска *Natch* в режиме записи и
воспроизведения работы соответственно, а так же *run_qemu.sh* для запуска Qemu без *Natch*.

Инструмент *Natch* агрегирован в плагине *natch*, который подключается к Qemu.

Прежде чем перейти к описанию скрипта, рассмотрим опцию для подключения конфигурационного файла плагина *natch*.
- *config*
Задает файл конфигурации инструмента (подробнее в разделе [ССЫЛКА](#main_config_label)).

Пример командной строки, отвечающей за подключение плагина с опцией *config*:
```
-plugin natch,config=natch_config.cfg
```
Скрипт *natch_run.py* имеет три параметра, один обязательный и два опциональных. Обязательный параметр это путь к образу системы, опциональные - путь к ядру (опция kernel эмулятора Qemu, если ядро ОС не загружается из образа системы) и название операционной системы, для которой будет использован инструмент (по умолчанию Linux, предоставляется выбор из следующих вариантов: Linux, FreeBSD). Так же скрипт можно запустить с опцией *-h* и получить справку по доступным опциям.

Описание команды и ее параметров представлено ниже:
```text
natch_run.py image [-h] [-k KERNEL] [-o {Linux, FreeBSD}]
```
Пример запуска скрипта:
```bash
LD_LIBRARY_PATH=/path_to_libs ./natch_run.py <image> -o Linux
```

Список вопросов, которые будут заданы при выполнении скрипта:
- *Путь к директории проекта* \
Необходимо указать полный путь или только название папки, которая будет создана для хранения всех скриптов, конфигураций и прочих файлов инструмента.
Внутри этой директории будет создана еще одна папка с именем *output*, в которую будут помещены выходные файлы работы инструмента.
Параметр является опциональным, в случае пропуска рабочий каталог будет называться именем запускаемого образа гостевой системы.
Если каталог уже существует, будет создан новый с постфиксом *_х*, где x - это число от 1 до максимально возможного.

- *Количество оперативной памяти* \
Необходимо указать объем оперативной памяти, выделяемый виртуальной машине. Указывается число в гигабайтах или мегабайтах с соответствующим постфиксом G или M, например 512M.

- *Сетевые опции* \
В этом меню пользователь может указать порты, которые необходимо пробросить в виртуальную машину. Запрос на ввод портов появится при выборе ответа *Y/y* или при нажатии клавиши *Enter*. Порты следует указывать через запятую. Указываемые порты должны лежать в диапазоне [1 .. 9999]. Порт для обращения к машине извне будет формироваться по принципу: *user_port + 10000*.

После этих вопросов скрипт попробует обратиться к утилите *qemu-img*, входящей в поставку эмулятора Qemu, чтобы создать оверлей для образа, необходимый для хранения состояний системы. Если оверлей создать не удалось, выполнение скрипта будет прервано.

Далее скрипт предложит создать конфигурационный файл для модулей. Если модули есть в наличии, то следует согласиться, в противном случае ввести *n* или *N*. Если конфигурационный файл нужен, будет предложено ввести путь к папке, содержащей модули.

Следующий вопрос коснется конфигурационного файла *task_config.ini*. Если вы впервые создаете конфигурацию для образа, следует воспользоваться ответом по умолчанию (нет). На этом этапе будет запущен эмулятор для извлечения информации о структурах ядра. Если же вы уже работали с этим образом и получали конфигурационный файл с этого этапа - вопрос можно пропустить, но не забудьте скопировать *task_config.ini* в рабочую директорию нового проекта. Если не уверены, что файл от нужного образа - лучше ответить нет и дождаться генерации файла.

Вопросы для пользователя закончились, далее при необходимости будет осуществлен настроечный запуск эмулятора, следует подождать пока он отработает и окно эмулятора закроется.

На этом настройка окончена. На экран будут выведены сгенерированные командные строки, а так же описание полученных скриптов.

Кроме командных строк будет сгенерирована заготовка конфигурационного файла *Natch*. В полученном файле описаны все возможные секции и поля с примерами заполнения, часть из которых закомментирована. При необходимости этот файл можно отредактировать -
раскомментировать нужные секции и внести актуальные значения параметров. Имя конфигурационного файла задается по умолчанию, а именно *natch_config.cfg*.

Помимо скрипта *natch_run.py* в поставку инструмента входит скрипт *module_config.py*. Этот скрипт запускается внутри основного, если пользователь соглашается создать конфигурационный файл для модулей. При необходимости его можно использовать отдельно, если, например, модули обновились, а проводить заново настройку инструмента не нужно.

Скрипт *natch_run.py* расположен в директории *natch_scripts*. Запускать скрипт можно из любого расположения, готовые скрипты для запуска инструмента и все конфигурационные файлы будут помещены в рабочей директории, указанной пользователем или назначенной автоматически.


## 4.2. Подготовка запуска Natch вручную

Скрипт *natch_run.py* призван упростить пользователю работу с инструментом, однако можно формировать командные строки для запуска самостоятельно. Пример конфигурационного файла *Natch* можно взять из документации.  

Пример командной строки для запуска *Natch*:

``./qemu-system-x86_64 -hda debian.qcow2 -m 6G -monitor stdio -netdev user,id=net0 -device e1000,netdev=net0 -os-version Linux -plugin natch,config=natch_config.cfg``

При первом ручном запуске *Natch* произойдет генерация конфигурационного файла *task_config.ini*. Следует дождаться завершения работы эмулятора, после чего можно запускать его для работы.

Однако, рекомендуемым вариантом использования *Natch* является его запуск с использованием детерминированного вопроизведения.

## 4.3. Запуск Natch с использованием детерминированного воспроизведения

Детерминированное воспроизведение состоит и двух фаз: запись и воспроизведение. Во время записи необходимо выполнить сценарий, который будет анализироваться во время следующих запусков в режиме воспроизведения.

При использовании скрипта для генерации командных строк, строки запуска для записи и воспроизведения будут получены автоматически: *run_record.sh* для записи и *run_replay.sh* для воспроизведения.

Таким образом для работы с *Natch* нужно записать сценарий работы виртуальной машины с помощью скрипта *run_record.sh* и воспроизводить его в дальнейшем с помощью скрипта *run_replay.sh*.

Скрипт *run_replay.sh* имеет необязательный параметр *snapshot_name*. Например, если во время записи был сохранен снэпшот с именем *load*, то запустить воспроизведение с этого момента можно либо передав скрипту параметр ``./run_replay.sh load``, либо отредактировав скрипт путем замены значения переменной *SNAPSHOT* с *init* на *load*.

Непосредственно работа с инструментом *Natch* никак не изменится при использовании детерминированного воспроизведения. Изменения коснутся лишь строки запуска самого эмулятора.

Если по какой-то причине вы не используете скрипт *natch_run.py*, ниже приведен пример строк запуска эмулятора в режимах записи и воспроизведения.

Пример командной строки для записи работы:

```text
./qemu-system-x86_64 -m 4G \
-icount shift=5,rr=record,rrfile=replay.bin \
-drive file=debian10.qcow2,if=none,snapshot,id=img-direct \
-drive driver=blkreplay,if=none,image=img-direct,id=img-blkreplay \
-device ide-hd,drive=img-blkreplay \
-netdev user,id=net0 \
-device e1000,netdev=net0 \
-object filter-replay,id=replay,netdev=net0 \
-monitor stdio \
```
  
Пример командной строки для воспроизведения работы:

```text
./qemu-system-x86_64 -m 4G \
-icount shift=5,rr=replay,rrfile=replay.bin \
-drive file=debian10.qcow2,if=none,snapshot,id=img-direct \
-drive driver=blkreplay,if=none,image=img-direct,id=img-blkreplay \
-device ide-hd,drive=img-blkreplay \
-netdev user,id=net0 \
-device e1000,netdev=net0 \
-object filter-replay,id=replay,netdev=net0 \
-monitor stdio \
-plugin natch,config=natch_config.cfg \
```


