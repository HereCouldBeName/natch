<div style="page-break-before:always;">
</div>

# <a name="record_replay"></a>7. Запись и воспроизведение сценариев

Запись и воспроизведение сценариев являются неотъемлемыми частями работы с инструментом.
Для выполнения этих действий на этапе создания проекта генерируются скрипты `run_record.sh` и `run_replay.h`
соответственно.

## <a name="record">7.1. Запись сценария

Под записью сценария понимается работа с вашим объектом оценки внутри виртуальной машины, где все действия записываются
и могут быть многократно проиграны заново. С версии *Natch 2.3* в рамках одного проекта можно создавать несколько сценариев,
например, если ваш объект оценки может быть запущен разными способами, или в образе имеется несколько объектов оценки.
В таких ситуациях нет необходимости создавать каждый раз новый проект.

Запись осуществляется с помощью скрипта `run_record.sh`.
При запуске скрипта будет запрошено имя сценария. В случае пропуска поля ввода, имя будет назначено автоматически (*record*).
Обратите внимание, что при указании одинаковых имен, сценарии будут перезаписаны. Сценарии располагаются в отдельных папках с указанными пользователем названиями.
В каждую такую папку после записи помещаются все необходимые для работы сценария файлы -- [конфигурационный файл для помеченных данных](16_app_configs.md#taint_config),
журнал, оверлей, логи сетевых взаимодействий и т.д.

На этапе записи существует важный момент -- необходимо сохранить состояние машины перед тем, как будет произведена работа с объектом оценки.
Тогда воспроизводить сценарий можно будет с момента сохранения снапшота.
В противном случае воспроизводиться будет все, включая загрузку операционной системы, толку от этого не много, а воспроизвести такой
сценарий если и получится, то понадобится очень много времени. Поэтому имеет смысл максимально ограничить полезные действия.
Сохранение состояния машины делается в консоли *Natch* с помощью команды:
```
savevm <name>
```

Где `<name>` название вашего снапшота. Снапшотов в процессе работы можно делать несколько и запоминать их не обязательно, на этапе воспроизведения все сохраненные
снапшоты будут показаны.

**Внимание!** Для появления приглашения `(natch)`, перед вводом команды следует нажать клавишу `Enter`.
Но даже если вы сразу без приглашения введете команду, она сработает.

Завершить работу с эмулятором можно любым удобным способом: ввести команду `q` в консоли *Natch* или просто закрыть окно эмулятора.


## <a name="replay">7.2. Воспроизведение сценария

Когда сценарий записан, можно переходить к этапу воспроизведения, на котором осуществляется анализ всего что происходило в системе и сбор логов.
Перед запуском скрипта `run_replay.sh`, следует определить источники пометки. Подробнее об источниках в разделе [Определение источников пометки](6_taint_source.md#taint_source).
Определяются они в [конфигурационном файле для помеченных данных](16_app_configs.md#taint_config), который расположен в папке сценария.
Сделано это с целью сохранения настроек пометок для конкретного сценария в рамках одного проекта.

В связи с тем, что сценариев в проекте может быть несколько, при запуске скрипта `run_replay.sh` ситуация может разворачиваться несколькими способами:

* *У нас один сценарий и один снапшот*. В этом случае воспроизведение запустится и отработает без участия пользователя.
* *У нас один сценарий и несколько снапшотов*. Сценарий будет выбран по умолчанию, а для загрузки нужного снапшота нужно будет выбрать его из меню (с помощью стрелочек и клавиши Enter).
* *У нас несколько сценариев и один снапшот (для выбранного сценария)*. Для выбора сценария будет отображено меню с доступными сценариями, снапшот загрузится автоматически.
* *У нас несколько сценариев и несколько снапшотов (для выбранного сценария)*. В обоих случаях будет отображено меню.

Помимо этого скрипт `run_replay.sh` имеет два необязательных параметра *scenario_name* и *snapshot_name*.
Например, если во время записи был создан сценарий с названием *sample* и в процессе работы был сохранен снапшот с именем *state*,
то запустить воспроизведение с этого момента можно передав скрипту параметры:
```bash
./run_replay.sh sample state
```
Обратите внимание, что требуется указывать оба параметра, в противном случае они будут проигнорированы, и скрипт будет вести себя как описано выше.
Если во время работы снапшот не был сохранен, то следует указать имя стартового снапшота, а именно *init*.

На этапе воспроизведения, кроме выбора сценария и снапшота, от пользователя больше ничего не требуется, только дождаться завершения работы эмулятора и
формирования архива `*.tar.zst` с результатами анализа.

Здесь же будет выведена статистика пометок. Если вдруг вы увидели во всех графах нули, значит в вашем сценарии ничего не пометилось и следует проверить
состояние файла `taint.cfg` соответствующего сценария, а так же удостовериться что работа с помеченными данными была после того как был сделан снапшот системы.


