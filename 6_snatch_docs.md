<div style="page-break-before:always;">
</div>

# <a name="snatch"></a>6. Графический интерфейс для анализа SNatch
  
*SNatch* – это инструмент с графическим интерфейсом, предназначенный для постобработки и отображения данных, полученных от инструмента *Natch*. Работать с этим интерфейсом можно через браузер.

## 6.1. Системные требования

Тестирование инструмента проводилось на ОС Ubuntu 20.04 и Ubuntu 22.04. В качестве браузеров использовались Google Chrome версии 105.0.5148.2 и выше и Mozilla Firefox версии 101.0 и выше.

Необходимые для функционирования *SNatch* пакеты будут автоматически установлены в ходе первоначальной настройки.

## 6.2. Настройка и запуск

Для работы графического интерфейса *SNatch* необходимо подготовить окружение, а именно установить ряд пакетов для Ubuntu и Python, а также создать базу данных. Все это делается автоматически с помощью скрипта *snatch_setup.sh*. Для установки потребуется пароль для sudo. **Важно! Запускать скрипт под sudo не нужно, дождитесь запроса пароля.** Пакеты для Python устанавливаются в виртуальную среду, таким образом пакеты на вашей машине не будут переустанавливаться и конфликтовать. Процесс займет некоторое время, запускать скрипт нужно только при первом использовании. Кроме того, повторный запуск скрипта приведет к удалению базы данных.

Помимо скрипта для настройки окружения в пакет поставки входят скрипты *snatch_run.sh* и *snatch_stop.sh* для запуска и остановки *SNatch* соответственно. Скрипт *snatch_run.sh* запускает необходимые для работы службы, а также открывает браузер с интерфейсом. В терминал, из которого был запущен скрипт, будут приходить сообщения от сервера, однако, он свободен для использования, поэтому по окончании работы из него же можно запустить скрипт *snatch_stop.sh* для остановки служб. Запускать *snatch_stop.sh* следует всегда, в противном случае процессы останутся висеть в памяти вашего компьютера до перезагрузки.

Все скрипты для *SNatch* можно запускать из любого расположения. Если по какой-то причине при запуске
*snatch_run.sh* страница в браузере не загрузилась, но при этом службы запустились, следует обновить страницу.

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_interface.png><figcaption>_Окно SNatch_</figcaption>
  
На данном рисунке показано окно *SNatch*, где цифрами обозначены основные элементы интерфейса:

1. Кнопка для повторной загрузки архив с файлами поверхности атаки (далее просто: "архив")
2. Пункт меню, открывающий граф вызовов
3. Кнопка генерации графа вызовов
4. Список графов процессов
5. Всплывающие меню для взаимодействия с проектами (создание нового, открытие существующих и удаление существующих)
6. Кнопка открытия меню взаимодействия с проектами
7. Название открытого проекта
8. Открытые вкладки с содержимым (таким как: графы вызовов и графы процессов)
9. Окно отображения содержимого

Для создания нового проекта необходимо нажатием на (6) открыть меню проектов и выбрать *New project...*. Для переключения между существующим проектами необходимо из меню проектов в списке *Existing projects:* выбрать название интересующего проекта. Для удаления проекта достаточно в списке проектов нажать на кнопку *del* рядом с именем удаляемого проекта.

При нажатии на (1) в уже открытом проекте пользователю будет предложено выбрать новый архив (данный архив получается в результате работы *Natch*), после чего текущие данные в проекте будут стёрты и заменены полученными в результате обработки предоставленного файла.

При создании нового проекта происходит открытие модального окна:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_newproj.png><figcaption>_Создание проекта_</figcaption>

В данном окне пользователь может ввести имя нового проекта в соответствующее поле *Project name*,
а также выбрать архив поверхности атаки в *Choose surface file* (данный архив получается в результате работы *Natch*). Если оба этих поля заполнены, то становится активна кнопка *Create*, по нажатию на которую произойдет закрытие данного модального окна, создание нового проекта, автоматическое переключение на него и запуск процесса обработки архива. При нажатии на кнопку *Close* происходит закрытие модального окна.

Во время обработки архива поверхности атаки в верхней части экрана появляется шкала прогресса следующего вида:
 
<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_progressbar.png><figcaption>_Шкала прогресса_</figcaption>

В процессе обработки текст, сопровождающий шкалу прогресса, будет изменяться таким образом, чтобы оповещать об актуальном статусе выполняемой задачи. Нажатие на кнопку *Abort* аварийно прерывает процесс обработки, и в данном случае корректное функционирование полученных данных не может быть гарантировано.

Основными интерактивными элементами, получаемыми в результате обработки архива поверхности атаки
и доступными в интерфейсе *SNatch*, являются: граф вызовов и граф процессов.

В процессе первоначальной обработки архива поверхности атаки граф вызовов не создаётся. Чтобы граф вызовов появился в проекте, необходимо нажать на кнопку *Generate* (3). По завершении процесса генерации в боковом меню проекта под пунктом *Call-graphs* появится строка *call-graph* с цифровым идентификатором. Для открытия графа вызовов достаточно нажатие на него в меню. После открытия появится новая вкладка с соответствующим названием, а в окне отображения содержимого откроется граф, представленный в виде древовидной структуры:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_cgraph_overview.png><figcaption>_Граф вызовов_</figcaption>

В корне отображаемых деревьев располагается идентификатор контекста, далее же идут адреса
вызываемых функций. Интерактивное взаимодействие с графом достигается с помощью нажатия на кнопки "+"/"-", которые раскрывают/сворачивают данную ветку. Также по нажатию на символ из трех горизонтальных отрезков рядом с корнем дерева происходит полное раскрытие или же сворачивание выбранного дерева.

В меню графа процессов есть три пункта: *task graph* (процессы с идентичными именами сливаются в один
примитив в пределах одного контейнера), *task graph all* (процессы не сливаются), *task graph content* (json представление графа). После выбора одного из этих пунктов открывается новая вкладка с соответствующим названием, а в окне отображения содержимого откроется граф, представленный следующим образом:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_ui.png><figcaption>_Граф процессов_</figcaption>

В данном окне присутствуют следующие элементы:

1. Номер активного шага выполнения
2. Шкала выбора активного шага выполнения
3. Выбор режима отображения графа
4. Легенда графа
5. Граф процессов

Значение в (1) отображается в соответствии с выбранным на (2) шагом. Перемещение по (2) можно осуществлять как перетаскиванием мышью, так и нажатием стрелок на клавиатуре при активной шкале.
Актуальные значения в легенде (4) следующие: бинарный файл, интерпретатор, файл скрипта (связанный с интерпретатором), сокет, текстовый файл, терминал, узел сети.
В (5) отображаются цветные (и серые в некоторых режимах) взаимодействующие узлы, взаимодействие
отображается стрелками. Толщина стрелки соответствует относительному объему данных при взаимодействии. Все узлы в (5) интерактивны, их расположение можно изменять удобным для пользователя образом.

При переключении режимов (3) отображаемые на (5) элементы будут изменяться соответствующим образом:

*Active* – отображаются элементы (узлы и стрелки), которые задействованы на текущем шаге.

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_active.png><figcaption>_Режим Active_</figcaption>


*Past* – отображаются элементы, которые задействованы на текущем шаге, а также те, которые произошли в прошлом (узлы и стрелки серого цвета).

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_past.png><figcaption>_Режим Past_</figcaption>

*Significant* – отображаются элементы, которые задействованы на текущем шаге, а также те узлы, которые были задействованы в прошлом и при этом еще будут задействованы в будущем, и прошедшие стрелки между ними (узлы и стрелки серого цвета).

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_signif.png><figcaption>_Режим Significant_</figcaption>

*All* – отображаются элементы, которые задействованы на текущем шаге, а также те узлы (но не стрелки), которые вообще существуют на схеме (узлы серого цвета).

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_all.png><figcaption>_Режим All_</figcaption>


В случае наличия информации о контейнерах, таковые будут отображены на графе в виде зеленых блоков, содержащих соответствующие им узлы (*cont_1* на рисунке):

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_container.png><figcaption>_Отображение контейнеров_</figcaption>

Также по двойному нажатию на стрелку в графе процессов в новой вкладке открывается соответствующий этому взаимодействию стек вызовов:

<img src=https://raw.githubusercontent.com/ispras/natch/main/images/snatch/snatch_tgraph_cstack.png><figcaption>_Стек вызовов_</figcaption>

## 6.3. Список горячих клавиш

### 6.3.1. Общие комбинации

- *Ctrl+Alt+N* – вызывает модальное окно создания нового проекта
- *Ctrl+Alt+G* – запускает одновременную генерацию флейм графа и графа вызовов
- *Ctrl+Alt+C* – открывает граф вызовов (при наличии)
- *Ctrl+Alt+F* – открывает флейм граф (при наличии)
- *Ctrl+Alt+P* – открывает граф процессов
- *Ctrl+Alt+M* – открывает граф модулей
- *Ctrl+Alt+L* – открывает временной граф процессов
- *Ctrl+Alt+R* – открывает дерево процессов
- *Ctrl+X* – закрывает текущую вкладку в окне *SNatch*
- *Shift+Tab* – выбирает следующую открытую вкладку в окне *SNatch*

### 6.3.2. Управление интерактивными элементами вкладок

Флейм граф:

- *→* – переход к следующей помеченной функции
- *←* – переход к предыдущей помеченной функции
- *Ctrl+↓* – сброс состояния flame графа

Граф процессов:

- *→* – переход к следующему шагу
- *←* – переход к предыдущему шагу
- *Ctrl+→* – переход к последнему шагу
- *Ctrl+←* – переход к первому шагу
- *Ctrl+↓* – выбор предыдущего режима отображения
- *Ctrl+↑* – выбор следующего режима отображения

Граф модулей:

- *→* – переход к следующему шагу
- *←* – переход к предыдущему шагу
- *Ctrl+→* – переход к последнему шагу
- *Ctrl+←* – переход к первому шагу
