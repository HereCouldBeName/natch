<div style="page-break-before:always;">
</div>

# <a name="app_module_config"></a>Приложение 4. Формат списка исполняемых модулей

Пример конфигурационного файла `module.cfg`:

```ini
    # module.cfg

    [Image1]
    path=vmlinux
    map=System.map
    textstart=0xffffffff81000000

    [Image2]
    path=exe/dpkg
    debuginfo=exe/dpkg.dbg

    [Image3]
    path=exe/apt-get

    [Image4]
    path=exe/cat
    debuginfo=exe/cat-8.32-31.fc35.x86_64.debug
    tieddebug=exe/dwp
    vmidb=vmidb/cat
```

Конфигурационный файл содержит набор секций с префиксом *Image*.

В каждой такой секции описывается отдельный бинарный файл.
В этой секции могут быть объявлены следующие поля: *path*, *map*, *textstart*, *debuginfo*, *tieddebug*, *vmidb*.
Обязательным является только *path* (путь к бинарному файлу в хостовой системе).
В поле *map* можно указать путь к файлу с символьной информацией, сгенерированной
компилятором или дизассемблером IDA (при использовании IDA для генерации map файлов нужно выставлять галочку *Segmentation information*).
А в *debuginfo* - путь к ELF-файлу с отладочными символами.

Дополнительно поддерживается разделённая на части отладочная информация. Путь к вспомогательному
файлу указывается в поле *tieddebug*.

Отладочная и символьная информация из исполняемых файлов может быть заранее разобрана и сохранена
во время работы конфигурационных скриптов. Путь к полученному хранилищу записывается в поле *vmidb*.

**Поле textstart**

В разделах типа *Image* вместе с *map* может быть задано поле *textstart*.
Как правило, нет необходимости определять *textstart* вручную, потому что это может
делать скрипт *module_config.py*. Если же утилита вывела сообщение об ошибке,
необходимо проанализировать бинарный файл самостоятельно.

*textstart* используется, если адреса в символьном файле абсолютные, а в исполняемом файле нет.
Так как модуль может загружаться в разные места памяти, необходимо вычислить смещение каждой функции от начала секции .text.
В поле *textstart* как раз и указывается адрес начала секции *.text*.
Это поле нужно в редких случаях, например, для ядерных модулей (см. ниже). В остальных случаях можно ничего не указывать.

Чтобы получить информацию о секциях в исполняемом файле, можно использовать утилиту *readelf*:

```bash
    readelf -S <config_name>
```

Пример, когда *textstart* необходимо указывать:

```text
    map-файл:

    ffffffffa0000bed t cleanup_module
    ffffffffa00008c2 t logring_syslog_write_raw
    ffffffffa0000a4b t init_module
    ffffffffa000098d t logring_syslog_write

    вывод утилиты readelf:

    Section Headers:
    [Nr] Name              Type             Address           Offset
         Size              EntSize          Flags  Link  Info  Align
    [ 0]                   NULL             0000000000000000  00000000
         0000000000000000  0000000000000000           0     0     0
    [ 1] .text             PROGBITS         0000000000000000  00000040
         0000000000000c8c  0000000000000000  AX       0     0     4
```

Нас интересуют секции типа *PROGBITS*. Если у них указан нулевой адрес, то их не получится
сопоставить с map-файлом при его загрузке в *Natch*.
Поэтому необходимо вручную определить адрес секции *.text*.

Пример, когда *textstart* не нужен:

```text
    map-файл:

    00000006:000000000000C000       .init_proc
    00000007:000000000000C030       .wget_netrc_db_free
    00000007:000000000000C040       .wget_bar_update
    00000007:000000000000C050       .seteuid
    00000007:000000000000C060       .chdir
    00000007:000000000000C070       .fileno
    00000007:000000000000C080       .wget_list_free
    00000007:000000000000C090       .dup2
    00000007:000000000000C0A0       .printf

    вывод утилиты readelf:

    Section Headers:
    [Nr] Name              Type             Address            Offset
         Size              EntSize          Flags  Link  Info  Align
    [11] .init             PROGBITS         000000000000c000   0000c000
         0000000000000017  0000000000000000 AX     0     0     4
```

Адрес секции здесь указан и он соответствует адресам, записанным в map-файле,
поэтому параметр *textstart* можно не указывать.


