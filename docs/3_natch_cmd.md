<div style="page-break-before:always;">
</div>

# <a name="natch_cmd"></a>3. Командный интерфейс Natch

```
Natch_v.3.2
Copyright (c) 2020-2024 ISP RAS

based on QEMU emulator v.7.2.0
Copyright (c) 2003-2022 Fabrice Bellard and the QEMU Project developers

Available builds: x86_64, aarch64

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         Natch version

main commands:
  {create,cr,record,replay,kvm,tuning,info,delete,edit,set,modules,settings}
                        use <cmd_name> -h/--help for additional information
    create (cr)         create project
    record              record scenario (only for project)
    replay              replay scenario (only for project)
    kvm                 launch QEMU kvm without Natch (only for x86_64)
    tuning              launch tuning (only for project)
    info                info about project (only for project)
    delete              delete scenario (only for project)
    edit                edit Natch config files (only for project)
    coverage            get coverage for code (only for project)
    set                 change some project settings (only for project)
    modules             add/update/copy modules in the project (requires sudo)
    settings            Natch shell settings
```

Для работы с инструментом *Natch* предусмотрен пул команд, объединенных под названием `natch`.

Главная команда `natch` имеет следующие субкоманды:

- ``create``
- ``record``
- ``replay``
- ``kvm``
- ``tuning``
- ``info``
- ``delete``
- ``edit``
- ``coverage``
- ``set``
- ``modules``
- ``settings``

Представленные команды могут иметь параметры или субкоманды, поэтому для получения информации
следует использовать параметр `-h/--help`, например:

```
user@user: natch edit -h
usage: natch edit [-h] {main,taint} ...

optional arguments:
  -h, --help    show this help message and exit

Natch configs editing:
  {main,taint,debug}  use <cmd_name> -h/--help for additional information
    main        edit main config natch.cfg
    taint       edit scenario config taint.cfg
    debug       edit config debug_info.cfg


```

## 3.1. Первый запуск Natch

С версии 3.2 инструмент поставляется с поддержкой двух архитектур: x86_64 и aarch64.

При первом запуске *Natch* будет предложено выбрать архитектуру по умолчанию. Далее, если вы собираетесь
работать только с одной архитектурой, ничего предпринимать не нужно.

Если необходимо использовать другую архитектуру, некоторые команды *Natch* получили параметр `-a/--arch`,
позволяющий выбрать нужную архитектуру, независимо от определенной архитектуры по умолчанию.

Архитектуру по умолчанию можно изменить в любой момент с помощью команды `natch settings arch`,
описанной ниже.


## 3.2. natch create

Команда `create` применятся для создания Natch-проекта и имеет два обязательных параметра:
название проекта (может быть просто название директории, которая будет создана в текущем расположении,
либо полный путь до будущего проекта) и путь к образу исследуемой системы.

Кроме того, имеется ряд необязательных параметров:

- `-a/--arch` -- выбор архитектуры (x86_64, aarch64)
- `-k/--kernel` -- путь до ядра
- `-o/--os_name` -- выбор гостевой ОС (Linux, FreeBSD, Win7, Win8, Win8.1, Win10)
- `-c/--config` -- путь до файла конфигурации для автоматического создания проекта

Подробнее о создании проекта можно узнать в разделе [Создание проекта](6_create_project.md#create_project).

## 3.3. natch record

Команда `record` служит для записи сценария, имеет один обязательный параметр -- имя сценария.
Запускаться должна исключительно из директории с проектом.

Подробнее о записи сценария в разделе [Запись сценария](8_scenario_work.md#record).

## 3.4. natch replay

Команда `replay` служит для воспроизведения ранее записанных сценариев, имеет ряд необязательных параметров:

* `scenario` -- название сценария
* `snapshot` -- название снапшота
* `--icount_start` -- icount, на котором следует начать сбор трассы
* `--icount_end` -- icount, на котором следует закончить сбор трассы
* `-d/--debug` -- отладочный вывод

Важно, что параметры имя сценария и название снапшота могут быть использованы только вместе.

При использовании параметров `icount_*` следует придерживаться следующих правил:

* параметры `icount_start` и `icount_end` могут быть использованы как вместе, так и по-отдельности
* если заданы оба, `icount_end` не может быть меньше чем `icount_start`
* `icount_start` не может быть меньше значения icount выбранного снапшота

Узнать текущий icount во время работы эмулятора можно с помощью команды монитора `info replay`.


Отладочный режим включает вывод командной строки запуска эмулятора на консоль, а так же сохранение ее в файл `debug_qemu_cmdline.ini`.

Запускаться команда `replay` должна из директории с проектом.

Подробнее о воспроизведении сценария в разделе [Воспроизведение сценария](8_scenario_work.md#replay).


## 3.5. natch kvm


## 3.6. natch tuning


## 3.7. natch info

Команда предоставляет информацию о существующих в проекте сценариях и сохраненных снапшотов для каждого из них.
Вызываться должна из рабочей директории проекта. В общем виде результат представляет собой таблицу следующего вида:

```
Existing scenarios:

----- sample ------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-03 15:57:57
load                          13563000904             2024-06-03 15:59:14

----- hello -------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-04 18:00:46
temp_snap                     8251101826              2024-06-04 18:01:23
very_very_long_name           11708689459             2024-06-04 18:01:37
```

Также команда имеет параметр `-s/--scenario` при использовании которого будет выведена информация по сохраненным
снапшотам для конкретного сценария:

```
natch info -s sample

----- sample ------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-03 15:57:57
load                          13563000904             2024-06-03 15:59:14
```

## 3.8. natch delete

## <a name="natch_cmd_edit">3.9. natch edit

Команда `edit` предназначена для более удобного редактирования конфигурационных файлов проекта --
главного (natch.cfg), конфигурационных файлов сценариев (taint.cfg), а также файла параметров
скачивания отладочной информации (`debug_info.cfg`).
Имеет следующие субкоманды: `main`, `taint` и `debug` соответственно.

Запускаться эти команды должны исключительно из директории с проектом.
При выполнении команды `natch edit main` сразу откроется файл natch.cfg, а в случае с
`natch edit taint` потребуется выбрать нужный сценарий.

При первом запуске *Natch* (начиная с версии 3.1) перед редактированием файлов будет предложено выбрать
текстовый редактор по умолчанию. Изменить эту настройку можно с помощью команды `natch settings editor`,
которая описана ниже.


## 3.10. natch coverage


## 3.11. natch set

Команда `change` служит для внесения изменений в настройки проекта. Запускаться должна из рабочей
директории проекта. Имеет ряд необязательных параметров:

- `-m/--memory`
  -- изменить размер оперативной памяти.
  Необходимо указать желаемый размер оперативной памяти, используя постфикс G или M.
- `-p/--ports`
  -- изменить отслеживаемые порты.
  Следует указать список новых портов для проброса через запятую без пробелов. Прошлый список будет заменен.
  Если нужно отменить проброс, необходимо указать значение параметра 0. Этот параметр затрагивает не только
  параметры запуска эмулятора, но и конфигурационные файлы сценариев (при желании).
- `-t/--text-mode`
  -- перевести работу эмулятора в текcтовый или графический режим.
  Чтобы переключиться в текстовый режим следует использовать аргумент *yes*, в противном случае -- *no*.

Пример использования:
```bash
natch change -m 8G -p 2222,8888,4343 -t no
```
Такой запуск приведет к изменению параметров запуска эмулятора (`qemu_opts.ini`),
а так же будет предложено выбрать в каких сценариях следует внести изменения и в их конфигурационные файлы.
Если такие изменения не требуются -- нужно нажать клавишу *ESC*.


## <a name="natch_cmd_modules">3.12. natch modules

Команда `modules` отвечает за работу с модулями в проекте и образе. Имеет субкоманды:

- `add` -- дополнение проекта новыми модулями
- `update` -- обновление текущих модулей в проекте
- `extract` -- извлечение файлов из образа в хостовую систему
- `copy` -- загрузка в образ файлов из хостовой системы

Команды `add` и `update` можно запускать только из рабочей директории проекта.

Для работы команд `natch modules` потребуется пароль администратора для монтирования образа.

#### Команда `natch modules add`

```
natch modules add [-h] (--host-dir HOST_DIR | --guest-dir GUEST_DIR)
```

Имеет взаимоисключающие параметры `--host-dir` и `--guest-dir`.
Оба параметра ожидают путь к директории с модулями, только в случае с `--host-dir` директория должна
находиться в хостовой машине, а при указании `--guest-dir` -- в гостевой.

В процессе работы команды будет проанализирован каталог с новыми модулями, исследованы зависимости
и скачана информация о библиотечных модулях (если есть), а так же перестроена символьная информация.

```bash
natch modules add --guest-dir /home/user/Sample1
```

На выходе получим новый `module.cfg` и обновленные каталоги с информацией о модулях.

#### <a name="natch_cmd_modules_update">Команда `natch modules update`

```
natch modules update [-h]
```

Не имеет параметров и делает все то же самое что `add`, но не с новыми модулями,
а уже существующими, на случай если в образе что-то изменилось, например, добавилось локальное хранилище
отладочной информации.

На выходе получим новый `module.cfg` и обновленные каталоги с информацией о модулях.

#### <a name="natch_cmd_modules_extract">Команда `natch modules extract`

Во время подготовки объекта оценки для анализа может возникать необходимость извлечь бинарные файлы
из образа в хостовую систему. Для этого в *Natch* предусмотрена команда `extract`.

```
natch modules extract [-h] -i IMAGE -p PATHS [PATHS ...] -D DEST [-e] [-d] [-l LOG]
```

Команда `extract` имеет следующие параметры:

- `-i/--image` -- путь к образу гостевой операционной системы (*обязательный* (вне проекта))
- `-d/--dest` -- путь к директории, в которую будут сохранены копируемые файлы (*обязательный*)
- `-p/--paths` -- список, содержащий пути до файлов/директорий в гостевой системе (*обязательный*)
- `-e/--exec` -- флаг, указывающий скачивать только бинарные файлы
- `-l/--log` -- путь к файлу, в который будет записан журнал работы
- `-d, --debug` -- флаг включения диагностических сообщений

Если команда запускается из рабочей директории проекта, указывать параметр `-i/--image` не требуется.

Директория для сохранения файлов из образа будет создана автоматически.

Пример запуска команды:

```bash
natch modules extract -i <path_to_img> -d <path_to_dest_folder> -p <list_paths_to_copy> -e
```


#### Команда `natch modules copy`

В *Natch* предусмотрена команда, обратная команде `extract`. Команда `copy` предусмотрена для
загрузки файлов из хостовой системы в гостевую.

```
natch modules copy [-h] -i IMAGE -p PATHS [PATHS ...] -D DEST [-e] [-d] [-l LOG]
```

Команда `copy` имеет следующие параметры:

- `-i/--image` -- путь к образу гостевой операционной системы (*обязательный* (вне проекта))
- `-d/--dest` -- путь к директории, в которую будут сохранены копируемые файлы (*обязательный*)
- `-p/--paths` -- список, содержащий пути до файлов/директорий в хостовой системе (*обязательный*)
- `-e/--exec` -- флаг, указывающий загружать только бинарные файлы
- `-l/--log` -- путь к файлу, в который будет записан журнал работы
- `-d, --debug` -- флаг включения диагностических сообщений


## 3.13. natch settings

Команда `settings` предназначена для изменения общих настроек инструмента.
На данный момент имеет две субкоманды: `editor` и `arch`.

- `editor` -- позволяет выбрать текстовый редактор по умолчанию, с помощью которого будут открываться на
   редактирование конфигурационные файлы проекта. Отображается список установленных на машине редакторов из
   предопределенного списка (`vim`, `vi`, `gedit`, `nano`, `subl`).
- `arch` -- позволяет определить архитектуру, используемую по умолчанию. Предлагается выбор из двух доступных
   архитектур - `x86_64` и `aarch64`.



