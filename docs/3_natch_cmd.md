<div style="page-break-before:always;">
</div>

# <a name="natch_cmd"></a>3. Командный интерфейс Natch

```
Natch_v.3.2
Copyright (c) 2020-2024 ISP RAS

based on QEMU emulator v.7.2.0
Copyright (c) 2003-2022 Fabrice Bellard and the QEMU Project developers

Available builds: x86_64, aarch64

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         Natch version

main commands:
  {create,cr,record,replay,kvm,tuning,info,delete,edit,set,modules,settings}
                        use <cmd_name> -h/--help for additional information
    create (cr)         create project
    record              record scenario (only for project)
    replay              replay scenario (only for project)
    kvm                 launch QEMU kvm without Natch (only for x86_64)
    tuning              launch tuning (only for project)
    info                info about project (only for project)
    delete              delete scenario (only for project)
    edit                edit Natch config files (only for project)
    coverage            get coverage for code (only for project)
    set                 change some project settings (only for project)
    modules             add/update/copy modules in the project (requires sudo)
    settings            Natch shell settings
```

Для работы с инструментом *Natch* предусмотрен пул команд, объединенных под названием `natch`.

Главная команда `natch` имеет следующие субкоманды:

- ``create``
- ``record``
- ``replay``
- ``kvm``
- ``tuning``
- ``info``
- ``delete``
- ``edit``
- ``coverage``
- ``set``
- ``modules``
- ``settings``

Представленные команды могут иметь параметры или субкоманды, поэтому для получения информации
следует использовать параметр `-h/--help`, например:

```
user@user: natch edit -h
usage: natch edit [-h] {main,taint} ...

optional arguments:
  -h, --help    show this help message and exit

Natch configs editing:
  {main,taint,debug}  use <cmd_name> -h/--help for additional information
    main        edit main config natch.cfg
    taint       edit scenario config taint.cfg
    debug       edit config debug_info.cfg


```

## 3.1. Первый запуск Natch

С версии 3.2 инструмент поставляется с поддержкой двух архитектур: x86_64 и aarch64.

При первом запуске *Natch* будет предложено выбрать архитектуру по умолчанию. Далее, если вы собираетесь
работать только с одной архитектурой, ничего предпринимать не нужно.

Если необходимо использовать другую архитектуру, некоторые команды *Natch* получили параметр `-a/--arch`,
позволяющий выбрать нужную архитектуру, независимо от определенной архитектуры по умолчанию.

Архитектуру по умолчанию можно изменить в любой момент с помощью команды `natch settings arch`,
описанной ниже.


## 3.2. natch create

Команда `create` применятся для создания Natch-проекта.

Параметры (обязательные выделены жирным шрифтом):

- **`workdir`** -- название проекта (либо название директории, которая будет создана в текущем расположении,
  либо полный путь до будущего проекта)
- **`image`** -- путь к образу исследуемой системы
- `-a/--arch` -- выбор архитектуры (x86_64, aarch64)
- `-k/--kernel` -- путь до ядра
- `-o/--os_name` -- выбор гостевой ОС (Linux, FreeBSD, Win7, Win8, Win8.1, Win10)
- `-c/--config` -- путь до файла конфигурации для автоматического создания проекта
- `-h/--help` -- справка по команде

Пример:
```
natch create test_sample Natch_testing_materials/test_image_debian.qcow2
```

Подробнее о создании проекта можно узнать в разделе [Создание проекта](6_create_project.md#create_project).

## 3.3. natch record

Команда `record` служит для записи сценария.
Запускаться должна из директории с проектом.

Параметры (обязательные выделены жирным шрифтом):

- **`-s/--scenario`** -- имя сценария
- `-d/--debug` -- отладочный вывод командной строки на экран и в файл `debug_qemu_cmdline.ini`
- `-h/--help` -- справка по команде

Пример:
```
natch record -s sample
```

Подробнее о записи сценария в разделе [Запись сценария](8_scenario_work.md#record).

## 3.4. natch replay

Команда `replay` служит для воспроизведения ранее записанных сценариев.
Запускаться должна из директории с проектом.

Параметры:

- `-s/--scenario` -- название сценария
- `-S/--start` -- icount или название снапшота, на котором следует начать сбор трассы
- `-E/--end` -- icount или название снапшота, на котором следует закончить сбор трассы
- `--no-check` -- отключение проверки изменения конфигурационного файла `taint.cfg`
- `-d/--debug` -- отладочный вывод командной строки на экран и в файл `debug_qemu_cmdline.ini`
- `-h/--help` -- справка по команде

При использовании параметров `--start/--end` следует придерживаться следующих правил:

* параметры `--start` и `--end` могут быть использованы как вместе, так и по-отдельности
* если заданы оба, значение параметра `--end` не может быть меньше чем `--start` (при использовании
  названий снапшотов они приводятся к числовому эквиваленту)

Если значение параметра `--start` не совпадает со значением `icount` ни одного из существующих снапшотов --
стартовый снапшот будет определен автоматически (ближаший слева).

Узнать текущий `icount` во время работы эмулятора можно с помощью команды монитора `info replay`.

Узнать диапазон `icount`-ов в сценарии можно с помощью команды `natch info -s <name>`.

Примеры:
```
natch replay
natch replay -s sample
natch replay --start login --end get_info
```

Подробнее о воспроизведении сценария в разделе [Воспроизведение сценария](8_scenario_work.md#replay).


## 3.5. natch kvm

Команда `kvm` предназначена для запуска эмулятора в режиме аппаратной виртуализации.

При использовании архитектуры `aarch64` выполнение этой команды приведет к запуску эмулятора QEMU
только без расширений *Natch*.

Может запускаться как из директории с проектом, так и вне ее.

Параметры:

- `-i/--image` -- путь к образу исследуемой системы (обязательно при запуске вне проекта)
- `-s/--snapshot` -- добавление опции `snapshot` для сохранности образа
- `-a/--arch` -- выбор архитектуры (x86_64, aarch64)
- `-d/--debug` -- отладочный вывод командной строки на экран и в файл `debug_qemu_cmdline.ini`
- `-h/--help` -- справка по команде

Примеры:
```
natch kvm -i Natch_testing_materials/test_image_debian.qcow2
natch kvm -s
```

Обычно используется для подготовки объекта оценки (подробнее в разделе [Настройка окружения для работы с Natch](5_setup_env.md#setup_env))
или для быстрого доступа к исследуемой системе.


## 3.6. natch tuning

Команда `tuning` служит для извлечения структур ядра исследуемой системы и создания или перезаписи
конфигурационного файла `task.cfg`.

Запускаться должна из директории с проектом.

Параметры:

- `-a/--arch` -- выбор архитектуры (x86_64, aarch64)
- `-d/--debug` -- отладочный вывод командной строки на экран и в файл `debug_qemu_cmdline.ini`
- `-h/--help` -- справка по команде

Если в вашем проекте уже имеется файл `task.cfg`, вы увидите следующий диалог:
```
You already have task.cfg
Do you want to do tuning again? [Y/n]
```

При отказе выполнение команды завершится, в случае согласия будет запущен эмулятор и следует дождаться
завершения его работы.

Команда может быть полезна, если вы используете проект, созданный на более старой версии *Natch*, и
существующий конфигурационный файл не соответствует текущей версии инструмента.


## 3.7. natch info

Команда `info` предоставляет информацию о существующих в проекте сценариях и сохраненных снапшотов для каждого из них.

Запускаться должна из рабочей директории проекта.

Параметры:

- `-s/--scenario` -- название сценария
- `-h/--help` -- справка по команде

Пример:

```
natch info

Existing scenarios:

----- sample ------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-03 15:57:57
load                          13563000904             2024-06-03 15:59:14

----- hello -------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-04 18:00:46
temp_snap                     8251101826              2024-06-04 18:01:23
very_very_long_name           11708689459             2024-06-04 18:01:37
```

Пример:

```
natch info -s sample

----- sample ------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-03 15:57:57
load                          13563000904             2024-06-03 15:59:14
```

## 3.8. natch delete

Команда `delete` позволяет удалить сценарии и связанные с ними файлы из рабочей директории.

Запускаться должна из рабочей директории проекта.

Параметры:

- `-s/--scenario` -- название сценария
- `-a/--all` -- удалить все сценарии
- `-h/--help` -- справка по команде

Пример:
```
natch delete -s test

Are you sure? [y/N] y
Scenario 'test' has been deleted
Do you want to remove output directory? [y/N] y
Output directory 'output_test' has been deleted
```

При наличии директории с выходными файлами для *SNatch* (если выполнялось воспроизведение сценария),
так же будет предложено удалить и ее.


## <a name="natch_cmd_edit">3.9. natch edit

Команда `edit` предназначена для более удобного редактирования конфигурационных файлов проекта --
главного (natch.cfg), конфигурационных файлов сценариев (taint.cfg), а также файла параметров
скачивания отладочной информации (`debug_info.cfg`).
Имеет следующие субкоманды: `main`, `taint` и `debug` соответственно.

Запускаться эти команды должны исключительно из директории с проектом.
При выполнении команды `natch edit main` сразу откроется файл natch.cfg, а в случае с
`natch edit taint` потребуется выбрать нужный сценарий.

При первом запуске *Natch* (начиная с версии 3.1) перед редактированием файлов будет предложено выбрать
текстовый редактор по умолчанию. Изменить эту настройку можно с помощью команды `natch settings editor`,
которая описана ниже.


## 3.10. natch coverage


## 3.11. natch set

Команда `change` служит для внесения изменений в настройки проекта. Запускаться должна из рабочей
директории проекта. Имеет ряд необязательных параметров:

- `-m/--memory`
  -- изменить размер оперативной памяти.
  Необходимо указать желаемый размер оперативной памяти, используя постфикс G или M.
- `-p/--ports`
  -- изменить отслеживаемые порты.
  Следует указать список новых портов для проброса через запятую без пробелов. Прошлый список будет заменен.
  Если нужно отменить проброс, необходимо указать значение параметра 0. Этот параметр затрагивает не только
  параметры запуска эмулятора, но и конфигурационные файлы сценариев (при желании).
- `-t/--text-mode`
  -- перевести работу эмулятора в текcтовый или графический режим.
  Чтобы переключиться в текстовый режим следует использовать аргумент *yes*, в противном случае -- *no*.

Пример использования:
```bash
natch change -m 8G -p 2222,8888,4343 -t no
```
Такой запуск приведет к изменению параметров запуска эмулятора (`qemu_opts.ini`),
а так же будет предложено выбрать в каких сценариях следует внести изменения и в их конфигурационные файлы.
Если такие изменения не требуются -- нужно нажать клавишу *ESC*.


## <a name="natch_cmd_modules">3.12. natch modules

Команда `modules` отвечает за работу с модулями в проекте и образе. Имеет субкоманды:

- `add` -- дополнение проекта новыми модулями
- `update` -- обновление текущих модулей в проекте
- `extract` -- извлечение файлов из образа в хостовую систему
- `copy` -- загрузка в образ файлов из хостовой системы

Команды `add` и `update` можно запускать только из рабочей директории проекта.

Для работы команд `natch modules` потребуется пароль администратора для монтирования образа.

#### Команда `natch modules add`

```
natch modules add [-h] (--host-dir HOST_DIR | --guest-dir GUEST_DIR)
```

Имеет взаимоисключающие параметры `--host-dir` и `--guest-dir`.
Оба параметра ожидают путь к директории с модулями, только в случае с `--host-dir` директория должна
находиться в хостовой машине, а при указании `--guest-dir` -- в гостевой.

В процессе работы команды будет проанализирован каталог с новыми модулями, исследованы зависимости
и скачана информация о библиотечных модулях (если есть), а так же перестроена символьная информация.

```bash
natch modules add --guest-dir /home/user/Sample1
```

На выходе получим новый `module.cfg` и обновленные каталоги с информацией о модулях.

#### <a name="natch_cmd_modules_update">Команда `natch modules update`

```
natch modules update [-h]
```

Не имеет параметров и делает все то же самое что `add`, но не с новыми модулями,
а уже существующими, на случай если в образе что-то изменилось, например, добавилось локальное хранилище
отладочной информации.

На выходе получим новый `module.cfg` и обновленные каталоги с информацией о модулях.

#### <a name="natch_cmd_modules_extract">Команда `natch modules extract`

Во время подготовки объекта оценки для анализа может возникать необходимость извлечь бинарные файлы
из образа в хостовую систему. Для этого в *Natch* предусмотрена команда `extract`.

```
natch modules extract [-h] -i IMAGE -p PATHS [PATHS ...] -D DEST [-e] [-d] [-l LOG]
```

Команда `extract` имеет следующие параметры:

- `-i/--image` -- путь к образу гостевой операционной системы (*обязательный* (вне проекта))
- `-d/--dest` -- путь к директории, в которую будут сохранены копируемые файлы (*обязательный*)
- `-p/--paths` -- список, содержащий пути до файлов/директорий в гостевой системе (*обязательный*)
- `-e/--exec` -- флаг, указывающий скачивать только бинарные файлы
- `-l/--log` -- путь к файлу, в который будет записан журнал работы
- `-d, --debug` -- флаг включения диагностических сообщений

Если команда запускается из рабочей директории проекта, указывать параметр `-i/--image` не требуется.

Директория для сохранения файлов из образа будет создана автоматически.

Пример запуска команды:

```bash
natch modules extract -i <path_to_img> -d <path_to_dest_folder> -p <list_paths_to_copy> -e
```


#### Команда `natch modules copy`

В *Natch* предусмотрена команда, обратная команде `extract`. Команда `copy` предусмотрена для
загрузки файлов из хостовой системы в гостевую.

```
natch modules copy [-h] -i IMAGE -p PATHS [PATHS ...] -D DEST [-e] [-d] [-l LOG]
```

Команда `copy` имеет следующие параметры:

- `-i/--image` -- путь к образу гостевой операционной системы (*обязательный* (вне проекта))
- `-d/--dest` -- путь к директории, в которую будут сохранены копируемые файлы (*обязательный*)
- `-p/--paths` -- список, содержащий пути до файлов/директорий в хостовой системе (*обязательный*)
- `-e/--exec` -- флаг, указывающий загружать только бинарные файлы
- `-l/--log` -- путь к файлу, в который будет записан журнал работы
- `-d, --debug` -- флаг включения диагностических сообщений


## 3.13. natch settings

Команда `settings` предназначена для изменения общих настроек инструмента.
На данный момент имеет две субкоманды: `editor` и `arch`.

- `editor` -- позволяет выбрать текстовый редактор по умолчанию, с помощью которого будут открываться на
   редактирование конфигурационные файлы проекта. Отображается список установленных на машине редакторов из
   предопределенного списка (`vim`, `vi`, `gedit`, `nano`, `subl`).
- `arch` -- позволяет определить архитектуру, используемую по умолчанию. Предлагается выбор из двух доступных
   архитектур - `x86_64` и `aarch64`.



