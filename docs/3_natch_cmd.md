<div style="page-break-before:always;">
</div>

# <a name="natch_cmd"></a>3. Командный интерфейс Natch

```
Natch_v.3.2
Copyright (c) 2020-2024 ISP RAS

based on QEMU emulator v.7.2.0
Copyright (c) 2003-2022 Fabrice Bellard and the QEMU Project developers

Available builds: x86_64, aarch64

optional arguments:
  -h, --help            show this help message and exit
  -v, --version         Natch version

main commands:
  {create,cr,record,replay,kvm,tuning,info,delete,edit,set,modules,settings}
                        use <cmd_name> -h/--help for additional information
    create (cr)         create project
    record              record scenario (only for project)
    replay              replay scenario (only for project)
    kvm                 launch QEMU kvm without Natch (only for x86_64)
    tuning              launch tuning (only for project)
    info                info about project (only for project)
    delete              delete scenario (only for project)
    edit                edit Natch config files (only for project)
    coverage            get coverage for code (only for project)
    set                 change some project settings (only for project)
    modules             add/update/copy modules in the project (requires sudo)
    settings            Natch shell settings
```

Для работы с инструментом *Natch* предусмотрен пул команд, объединенных под названием `natch`.

Главная команда `natch` имеет следующие субкоманды:

- ``create``
- ``record``
- ``replay``
- ``kvm``
- ``tuning``
- ``info``
- ``delete``
- ``edit``
- ``coverage``
- ``set``
- ``modules``
- ``settings``

Представленные команды могут иметь параметры или субкоманды, поэтому для получения информации
следует использовать параметр `-h/--help`, например:

```
user@user: natch edit -h
usage: natch edit [-h] {main,taint} ...

optional arguments:
  -h, --help    show this help message and exit

Natch configs editing:
  {main,taint,debug}  use <cmd_name> -h/--help for additional information
    main        edit main config natch.cfg
    taint       edit scenario config taint.cfg
    debug       edit config debug_info.cfg


```

## 3.1. natch create

Команда `create` применятся для создания Natch-проекта и имеет два обязательных параметра:
название проекта (может быть просто название директории, которая будет создана в текущем расположении,
либо полный путь до будущего проекта) и путь к образу исследуемой системы.

Кроме того, имеется ряд необязательных параметров:

- `-a/--arch` -- выбор архитектуры (x86_64, aarch64)
- `-k/--kernel` -- путь до ядра
- `-o/--os_name` -- выбор гостевой ОС (Linux, FreeBSD, Win7, Win8, Win8.1, Win10)
- `-c/--config` -- путь до файла конфигурации для автоматического создания проекта

Подробнее о создании проекта можно узнать в разделе [Создание проекта](6_create_project.md#create_project).

## 3.2. natch record

Команда `record` служит для записи сценария, имеет один обязательный параметр -- имя сценария.
Запускаться должна исключительно из директории с проектом.

Подробнее о записи сценария в разделе [Запись сценария](8_scenario_work.md#record).

## 3.3. natch replay

Команда `replay` служит для воспроизведения ранее записанных сценариев, имеет ряд необязательных параметров:

* `scenario` -- название сценария
* `snapshot` -- название снапшота
* `--icount_start` -- icount, на котором следует начать сбор трассы
* `--icount_end` -- icount, на котором следует закончить сбор трассы
* `-d/--debug` -- отладочный вывод

Важно, что параметры имя сценария и название снапшота могут быть использованы только вместе.

При использовании параметров `icount_*` следует придерживаться следующих правил:

* параметры `icount_start` и `icount_end` могут быть использованы как вместе, так и по-отдельности
* если заданы оба, `icount_end` не может быть меньше чем `icount_start`
* `icount_start` не может быть меньше значения icount выбранного снапшота

Узнать текущий icount во время работы эмулятора можно с помощью команды монитора `info replay`.


Отладочный режим включает вывод командной строки запуска эмулятора на консоль, а так же сохранение ее в файл `debug_qemu_cmdline.ini`.

Запускаться команда `replay` должна из директории с проектом.

Подробнее о воспроизведении сценария в разделе [Воспроизведение сценария](8_scenario_work.md#replay).

## 3.4. natch info

Команда предоставляет информацию о существующих в проекте сценариях и сохраненных снапшотов для каждого из них.
Вызываться должна из рабочей директории проекта. В общем виде результат представляет собой таблицу следующего вида:

```
Existing scenarios:

----- sample ------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-03 15:57:57
load                          13563000904             2024-06-03 15:59:14

----- hello -------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-04 18:00:46
temp_snap                     8251101826              2024-06-04 18:01:23
very_very_long_name           11708689459             2024-06-04 18:01:37
```

Также команда имеет параметр `-s/--scenario` при использовании которого будет выведена информация по сохраненным
снапшотам для конкретного сценария:

```
natch info -s sample

----- sample ------------------------------------------------------------
Snapshot list:
NAME                          ICOUNT                  DATE
init                          0                       2024-06-03 15:57:57
load                          13563000904             2024-06-03 15:59:14
```

## 3.5. natch edit

Команда `edit` предназначена для более удобного редактирования конфигурационных файлов проекта --
главного (natch.cfg), конфигурационных файлов сценариев (taint.cfg), а также файла параметров
скачивания отладочной информации (`debug_info.cfg`).
Имеет следующие субкоманды: `main`, `taint` и `debug` соответственно.

Запускаться эти команды должны исключительно из директории с проектом.
При выполнении команды `natch edit main` сразу откроется файл natch.cfg, а в случае с
`natch edit taint` потребуется выбрать нужный сценарий.

При первом запуске *Natch* (начиная с версии 3.1) перед редактированием файлов будет предложено выбрать
текстовый редактор по умолчанию. Изменить эту настройку можно с помощью команды `natch settings editor`,
которая описана ниже.

## 3.6. natch modules

Команда `modules` позволяет дополнить проект новыми модулями или обновить текущие, имеет
две субкоманды `add` и `update` соответственно.

Как и вышеописанные команды, запускать их можно только из рабочей директории проекта.

Команда `natch modules add` имеет параметр `dir` -- путь к директории с модулями, которые требуется добавить в проект.
В процессе работы команды будет проанализирован каталог с новыми модулями, исследованы зависимости
и скачана информация о библиотечных модулях (если есть), а так же перестроена символьная информация.

```bash
natch modules add <dir>
```

Команда `natch modules update` не имеет параметров и делает все то же самое, но не с новыми модулями,
а уже существующими, на случай если в образе что-то изменилось, например, добавилось локальное хранилище
отладочной информации.

Для работы потребуется пароль администратора для монтирования образа. На выходе получим новый `module.cfg` и
обновленные каталоги с информацией о модулях.


## 3.7. natch change

Команда `change` служит для внесения изменений в настройки проекта. Запускаться должна из рабочей
директории проекта. Имеет ряд необязательных параметров:

- `-m/--memory`
  -- изменить размер оперативной памяти.
  Необходимо указать желаемый размер оперативной памяти, используя постфикс G или M.
- `-p/--ports`
  -- изменить отслеживаемые порты.
  Следует указать список новых портов для проброса через запятую без пробелов. Прошлый список будет заменен.
  Если нужно отменить проброс, необходимо указать значение параметра 0. Этот параметр затрагивает не только
  параметры запуска эмулятора, но и конфигурационные файлы сценариев (при желании).
- `-t/--text-mode`
  -- перевести работу эмулятора в текcтовый или графический режим.
  Чтобы переключиться в текстовый режим следует использовать аргумент *yes*, в противном случае -- *no*.

Пример использования:
```bash
natch change -m 8G -p 2222,8888,4343 -t no
```
Такой запуск приведет к изменению параметров запуска эмулятора (`qemu_opts.ini`),
а так же будет предложено выбрать в каких сценариях следует внести изменения и в их конфигурационные файлы.
Если такие изменения не требуются -- нужно нажать клавишу *ESC*.




## 3.8. natch settings

Команда `settings` на данный момент имеет только одну субкоманду `editor`, позволяющую
выбрать текстовый редактор по умолчанию, с помощью которого будут открываться на
редактирование конфигурационные файлы проекта.



